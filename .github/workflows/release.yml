name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    name: build (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: macos-15-intel
            target: x86_64-apple-darwin
          - os: macos-14
            target: aarch64-apple-darwin
          - os: windows-latest
            target: x86_64-pc-windows-msvc

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Build release
        run: cargo build --release --locked --target ${{ matrix.target }}

      - name: Package (unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          cp target/${{ matrix.target }}/release/dpc dist/
          tar -czf dist/dpc-${{ matrix.target }}.tar.gz -C dist dpc
          rm dist/dpc

      - name: Package (windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          Copy-Item target/${{ matrix.target }}/release/dpc.exe dist/
          Compress-Archive -Path dist/dpc.exe -DestinationPath ("dist/dpc-${{ matrix.target }}.zip") -Force
          Remove-Item -Force dist/dpc.exe

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.target }}
          path: dist/*
          if-no-files-found: error

  publish:
    name: publish
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Publish release assets
        uses: softprops/action-gh-release@v2
        with:
          files: dist/**/*
          generate_release_notes: true

  homebrew:
    name: homebrew
    runs-on: ubuntu-latest
    needs: publish
    env:
      HOMEBREW_TAP_REPO_VAR: ${{ vars.HOMEBREW_TAP_REPO }}
      HOMEBREW_FORMULA_PATH_VAR: ${{ vars.HOMEBREW_FORMULA_PATH }}
    steps:
      - name: Gate Homebrew publish
        id: gate
        shell: bash
        env:
          HOMEBREW_TAP_GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          HOMEBREW_TAP_REPO="${HOMEBREW_TAP_REPO_VAR:-trmdy/homebrew-tap}"
          HOMEBREW_FORMULA_PATH="${HOMEBREW_FORMULA_PATH_VAR:-Formula/dpc.rb}"
          {
            echo "HOMEBREW_TAP_REPO=${HOMEBREW_TAP_REPO}"
            echo "HOMEBREW_FORMULA_PATH=${HOMEBREW_FORMULA_PATH}"
          } >> "${GITHUB_ENV}"

          if [ -z "${HOMEBREW_TAP_GITHUB_TOKEN}" ]; then
            echo "enabled=false" >> "${GITHUB_OUTPUT}"
            echo "Homebrew: skipped (missing HOMEBREW_TAP_GITHUB_TOKEN secret)." >> "${GITHUB_STEP_SUMMARY}"
            exit 0
          fi

          echo "enabled=true" >> "${GITHUB_OUTPUT}"

      - name: Download artifacts
        if: steps.gate.outputs.enabled == 'true'
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Validate Homebrew config
        if: steps.gate.outputs.enabled == 'true'
        shell: bash
        env:
          HOMEBREW_TAP_GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${HOMEBREW_TAP_REPO}" ]; then
            echo "::error::Missing HOMEBREW_TAP_REPO (repo variable)."
            exit 1
          fi
          if [ -z "${HOMEBREW_FORMULA_PATH}" ]; then
            echo "::error::Missing HOMEBREW_FORMULA_PATH (repo variable)."
            exit 1
          fi
          if [ -z "${HOMEBREW_TAP_GITHUB_TOKEN}" ]; then
            echo "::error::Missing HOMEBREW_TAP_GITHUB_TOKEN (secret)."
            exit 1
          fi

      - name: Resolve macOS checksums
        if: steps.gate.outputs.enabled == 'true'
        id: checksums
        shell: bash
        run: |
          set -euo pipefail
          version="${GITHUB_REF_NAME#v}"
          if [ -z "${version}" ] || [ "${version}" = "${GITHUB_REF_NAME}" ]; then
            echo "::error::Tag must be in form vX.Y.Z."
            exit 1
          fi

          arm_file="$(find dist -name 'dpc-aarch64-apple-darwin.tar.gz' -print -quit)"
          x86_file="$(find dist -name 'dpc-x86_64-apple-darwin.tar.gz' -print -quit)"
          if [ -z "${arm_file}" ] || [ -z "${x86_file}" ]; then
            echo "::error::Missing macOS artifacts in dist."
            find dist -maxdepth 3 -type f -print || true
            exit 1
          fi

          arm_sha="$(sha256sum "${arm_file}" | awk '{print $1}')"
          x86_sha="$(sha256sum "${x86_file}" | awk '{print $1}')"

          echo "version=${version}" >> "${GITHUB_OUTPUT}"
          echo "arm_sha=${arm_sha}" >> "${GITHUB_OUTPUT}"
          echo "x86_sha=${x86_sha}" >> "${GITHUB_OUTPUT}"

      - name: Checkout Homebrew tap
        if: steps.gate.outputs.enabled == 'true'
        uses: actions/checkout@v4
        with:
          repository: ${{ env.HOMEBREW_TAP_REPO }}
          token: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
          path: homebrew-tap

      - name: Update formula
        if: steps.gate.outputs.enabled == 'true'
        shell: bash
        env:
          VERSION: ${{ steps.checksums.outputs.version }}
          ARM_SHA: ${{ steps.checksums.outputs.arm_sha }}
          X86_SHA: ${{ steps.checksums.outputs.x86_sha }}
        run: |
          set -euo pipefail
          formula="homebrew-tap/${HOMEBREW_FORMULA_PATH}"
          if [ ! -f "${formula}" ]; then
            echo "::error::Formula not found: ${formula}"
            exit 1
          fi
          echo "Formula path: ${formula}"
          echo "Formula head:"
          sed -n '1,120p' "${formula}"

          export FORMULA="${formula}"
          python - <<'PY'
          import os
          import pathlib
          import re

          formula = pathlib.Path(os.environ["FORMULA"])
          version = os.environ["VERSION"]
          arm_sha = os.environ["ARM_SHA"]
          x86_sha = os.environ["X86_SHA"]

          text = formula.read_text()
          text, n1 = re.subn(r'version\\s+\"[^\"]+\"', f'version \"{version}\"', text)
          # Prefer structural matching over asset-filename matching. Tap formulas may choose different
          # URL naming schemes, but the on_macos + if/else structure is stable.
          text, n2 = re.subn(
              r'(if\\s+Hardware::CPU\\.arm\\?\\s*\\n\\s*url\\s+\"[^\"]+\"\\s*\\n\\s*sha256\\s+\")[^\"]+(\"\\s*)',
              r'\\1' + arm_sha + r'\\2',
              text,
          )
          text, n3 = re.subn(
              r'(else\\s*\\n\\s*url\\s+\"[^\"]+\"\\s*\\n\\s*sha256\\s+\")[^\"]+(\"\\s*)',
              r'\\1' + x86_sha + r'\\2',
              text,
          )
          if n1 == 0 or n2 == 0 or n3 == 0:
              msg = f"Pattern update failed (n1={n1}, n2={n2}, n3={n3}); check formula format."
              raise SystemExit(msg)
          formula.write_text(text)
          PY

      - name: Commit and push
        if: steps.gate.outputs.enabled == 'true'
        shell: bash
        env:
          VERSION: ${{ steps.checksums.outputs.version }}
        run: |
          set -euo pipefail
          cd homebrew-tap
          if git diff --quiet; then
            echo "No Homebrew changes."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "${HOMEBREW_FORMULA_PATH}"
          git commit -m "dpc ${VERSION}"
          git push
